%%---------------------------------------------------------------------------%%
%% draco-emacs.tex
%% Thomas M. Evans
%% $Id$
%%---------------------------------------------------------------------------%%
\documentclass[11pt]{nmemo}
\usepackage[centertags]{amsmath}
\usepackage{amssymb,amsthm,graphicx}
\usepackage[mathcal]{euscript}       
\usepackage{tabularx}
\usepackage{tmadd,tmath}
\usepackage{cite}
\usepackage{c++}
\usepackage{fancycodes}  % needed to get ``LaTeX'' symbol.
\usepackage{float} % used for C++ example code.
\usepackage{shading}
\usepackage{fancybox}
%\usepackage{url}
\usepackage[hang,small]{caption2}

%%---------------------------------------------------------------------------%%
%% DEFINE SPECIFIC ENVIRONMENTS HERE
%%---------------------------------------------------------------------------%%
%\newcommand{\elfit}{\ensuremath{\operatorname{Im}(-1/\epsilon(\vq,\omega)}}
%\msection{}-->section commands
%\tradem{}  -->add TM subscript to entry
%\ucatm{}   -->add trademark footnote about entry

\newcommand{\comp}[1]{{\normalfont\texttt#1}}
\newcommand{\draco}{{\normalfont\sffamily Draco}}
\newcommand{\milagro}{{\normalfont\sffamily Milagro}}
\newcommand{\dante}{{\normalfont\sffamily Dante}}
\newcommand{\xemacs}{{\normalfont\bfseries XEmacs}}
\newcolumntype{Y}{>{\centering\arraybackslash}X}
\newcolumntype{L}{>{\ttfamily}X}

% how much of the page can be occupied by text when a float is on the
% same page.
\renewcommand{\floatpagefraction}{0.8}
\renewcommand{\textfraction}{0.15}
\renewcommand{\bottomfraction}{0.4}
\renewcommand{\topfraction}{0.9}

\floatstyle{plain}

\setlength{\belowcaptionskip}{3ex plus 4pt minus 2pt}
\setlength{\abovecaptionskip}{2ex plus 4pt minus 2pt}

\newfloat{cxxSampleCode}{!ht}{lom}
  \floatname{cxxSampleCode}{Code Example}

\newenvironment{codeExample}
{\footnotesize 
  \VerbatimEnvironment
  \begin{SaveVerbatim}{\mycode}}%
  {\end{SaveVerbatim}%
  \noindent%
  \parashade[.950]{sharpcorners}{\gdef\outlineboxwidth{.5}%
    \UseVerbatim{\mycode}}\normalsize}

%%---------------------------------------------------------------------------%%
%% BEGIN DOCUMENT
%%---------------------------------------------------------------------------%%
\begin{document}

%%---------------------------------------------------------------------------%%
%% OPTIONS FOR NOTE
%%---------------------------------------------------------------------------%%

\toms{Distribution}
%\toms{Joe Sixpak/XTM, MS B226}
\refno{CCS-4--01-XX(U)}
\subject{XEmacs Development Environment for Draco (Revision 2)}

%-------NO CHANGES
\divisionname{Computer and Computational Sciences Division}
\groupname{CCS--4:Transport Methods Group}
\fromms{Kelly G. Thompson/CCS--4, MS D409\\
Tom M. Evans/CCS--4, MS D409}
\phone{(505)665--3929}
\originator{kgt}
\typist{kgt}
\date{\today}
%-------NO CHANGES

%-------OPTIONS
%\reference{NPB Star Reimbursable Project}
%\thru{P. D. Soran, XTM, MS B226}
%\enc{list}      
%\attachments{list}
%\cy{list}
%\encas
%\attachmentas
%\attachmentsas 
%-------OPTIONS

%%---------------------------------------------------------------------------%%
%% DISTRIBUTION LIST
%%---------------------------------------------------------------------------%%

\distribution {
  CCS-4 MS D409:\\ 
  M. Buksas, CCS--4, MS D409\\
  B.A. Clark, CCS--4, MS D409
  T.M. Evans, CCS--4, MS D409\\ 
  M.G. Gray, CCS--4, MS D409\\ 
  H.G. Hughes, CCS--4, MS D409\\ 
  J.M. McGhee, CCS--4, MS D409\\ 
  J.E. Morel, CCS--4, MS D409\\ 
  G.L. Olson, CCS--4, MS D409\\ 
  S.D. Pautz, CCS--4, MS D409\\ 
  K.G. Thompson, CCS--4, MS D409\\
  S.A. Turner, CCS--4, MS D409\\ 
  T.J. Urbatsch, CCS--4, MS D409\\ 
  J.S. Warsa, CCS--4, MS D409\\
  }

%%---------------------------------------------------------------------------%%
%% BEGIN NOTE
%%---------------------------------------------------------------------------%%

\opening

\section{Comments on Revision 2}
This memo was originally issued by Tom Evans in Sept. of 1999 as
internal memo XTM:99--09(U).  The Draco elisp routines have changed a
bit since then so I am issuing an updated version of Tom's memo.

\section{Introduction}

\draco~\cite{rn98046} has been built using an informal \xemacs-based
design environment.  As part of the \draco\ reorganization
project~\cite{draco-build} we have sorted through the existing Elisp
functions and macros that have defined this informal \draco\ 
environment.  These files that define the \draco\ development
environment, have been cleaned up and released (as of this writing the
release tag was rtt-elisp\_v21).  With this release we have a formal
development environment for \draco.

Our goal is for all files in \draco\ to have the same ``look and
feel.''  To accomplish this we employ the \xemacs\ editor with a
defined set of modes and functions that both expedite and homogenize
code and document development in \draco.  Additionally, templates are
provided that contain header information and formats.  Thus, all
source code files in \draco\ will obtain the same ``look'' simply by
using this environment.

The \draco\ development environment consists of a series of Elisp
(\comp{.el}) files that need to be loaded from the user's
\comp{.emacs} file.  The \xemacs\ \draco\ development environment
provides the following features:
\begin{itemize}
\item A set of templates providing standard headers and footers for
  \draco\ source code.
\item A \draco\ \C++ indentation style for \xemacs.
\item Functions to expedite editing of source code (including \LaTeX)
  and package creation in \draco.
\item Pull down \xemacs\ menu for easy access to many \draco\ specific
  commands and programming modes.
\end{itemize}
We will show how to load the \draco\ development environment and
analyze these features in the following sections.

%%---------------------------------------------------------------------------%%

\section{Draco Elisp Files}

The files that constitute the \xemacs\ \draco\ development environment
are listed in Table~\ref{tab:elisp}.  These files can be obtained
through a CVS export~\cite{cvs}: 

%
\begin{table}[!htbp]%
  \caption{Files that are part of the \draco\ development environment
    distribution, rtt-elisp\_v21.}%
  \label{tab:elisp}
  \begin{center}
    \begin{tabularx}{\linewidth}{
        >{\setlength{\hsize}{.8\hsize}}L %
        >{\setlength{\hsize}{.4\hsize}}Y %
        >{\setlength{\hsize}{1.8\hsize}}X}
      \hline\hline
      \multicolumn{1}{Y}{File} & Required &
      \multicolumn{1}{Y}{Description} \\ \hline
      Config-key.el & no & describes some key-bindings \\
      Config-pkg.el & yes & does package configurations for
      environments used in (and outside) of \draco \\
      dante-macros.el & no & Dante specific function definitions. \\
      draco-hacks.el & yes & \draco-specific function definitions \\
      draco-rtt.el & yes & loads the \draco\ environment and other
      packages \\
      fl-keywords.el & yes & font-lock keywords used throughout the
      \draco\ package \\
      infer-cc-style.el & yes & functionality for inferring
      \comp{c\--indentation\--styles} \\
      infer-mode.el & yes & functionality for inferring the \xemacs\
      mode from strings in file headers \\
      pooma-hacks.el & yes & c-style used by the POOMA team \\
      mppl-mode.el & no & mode definition for MPPL (a Fortran
      preprocessor) \\
      nml-mode.el & yes & \comp{nml} mode definition \\
      rtt-hacks.el & yes & defines the \comp{rtt-c-style} \\
      rtt-menu.el & no & creates a pull down menu with many \draco\
      specific functions \\
      tme-hacks.el & yes & contains functions used by the \draco\
      environment \\
      xemacs-setup.el & no & key-bindings that may be useful to \draco\ 
      developers \\ 
      \hline\hline
    \end{tabularx}
  \end{center}
\end{table}
\begin{verbatim}
     $ cvs export -r HEAD elisp
\end{verbatim} % $
Note that not all files are required by the \draco\ development
environment.  These additional Elisp components are included because
they may be useful for general work in CCS--4.  In addition to the
\comp{elisp/} directory, a \comp{elisp/templates} directory is
generated from the CVS export.  These templates are used by functions
in \comp{tme-hacks} and are not part of the official \draco\ 
development environment.  However, these templates are useful when
writing code and documents outside of \draco.

The \comp{elisp/} directory that results from CVS export should be
placed in a suitable location.  In general, one of the following two
locations are recommended:
\begin{verbatim}
     $HOME/elisp
     $HOME/lib/elisp
\end{verbatim}

(kt - Is this still true?) 

Note that if the general templates (non-\draco) from \comp{tme-hacks}
are desired then the \comp{elisp/} directory should be placed in
\comp{\$HOME/lib/elisp}.  However, the placement of the elisp
directory will not affect the \draco\ development environment
functionality.

\subsection{\comp{.emacs} File}
\label{sec:.emacs}

The \draco\ environment is loaded from the \comp{.emacs} file.
Appendix~\ref{.emacs} lists a model \comp{.emacs} file that loads the
complete \draco\ development environment.  This file also loads
additional packages such as \comp{xemacs-setup} and \comp{tme-keys}
that are primarily key-bindings.  Each user should add an Elisp file
in \comp{elisp/} that describes the key bindings and Elisp
\comp{mode-hooks} that he/she wants.  An example of such a file is
\comp{tme-keys} that may be viewed in
\begin{verbatim}
     /home/tme/lib/elisp/tme-keys.el
\end{verbatim}
For convenience, this file is reproduced in \S~\ref{tme-keys}.
Additional functionality can be added by users to suit additional
needs outside of \draco\ by simply making their own Elisp files in
this manner.

We will use the \comp{.emacs} file in \S~\ref{.emacs} as a template
for what follows.  The following code determines where the user's
\$HOME directory is located, where the 
user-installed \comp{elisp/} directory is located and where the
default templates directory is located.  The last line adds the elisp
directory to the default path that \xemacs\ uses to locate packages.

\begin{verbatim}
     (setq my-home-dir (concat (getenv "HOME") "/")
     (setq my-elisp-dir (concat my-home-dir "lib/elisp/"))
     (setq my-templates-dir (concat my-elisp-dir "templates/"))
     (if (file-accessible-directory-p my-elisp-dir)
         (setq load-path (cons my-elisp-dir load-path)))
\end{verbatim}

To load the elisp packages that define the \draco\ environment the
you will need to include
the following pieces of code in your \comp{.emacs} file.  Before you
load any of the actual elisp you need to define the requested
environment.  The suggested setup below tells the \draco\ elisp
routines to avoid pooma-style formatting, to load the RTT \xemacs\ menu
and to load the RTT suggested language mode-hooks for each of the modes
listed. 
 
\begin{verbatim}
     (set want-pooma-style-by-default nil
          want-rtt-menu               t)

     (setq config-pkg-verbose t
           want-mppl-mode     t
           want-tcl-mode      t
           want-python-mode   t
           want-nml-mode      t
           want-makefile-mode t
           want-cc-mode       t
           want-auctex-pkg    t
           want-f90-mode      t
           want-python-mode   t
           want-fortran-mode  t)
\end{verbatim}

\comp{Auctex} is a useful mode for editing \TeX\ and \LaTeX\ source
files.  See \comp{Config-pkg.el} for descriptions of the rest of
language modes.  The \draco\ elisp routines are incorporated into the
\xemacs\ environment next.

\begin{verbatim}
     (require 'draco-rtt)
\end{verbatim}

To enable language support for the following modes, we use the
following code:

\begin{verbatim}
     (require 'Config-pkg)
\end{verbatim}

You may also want to load some keyboard shortcuts and macros defined
by Tom or Jeff.  The following commands will load some of
these optional settings.

\begin{verbatim}
     (load-library ``xemacs-setup'')
\end{verbatim}

For additional descriptions of commands in the sample \comp{.emacs}
file see the \xemacs\ help menu or the \xemacs\ web page
(http://www.xemacs.org). 

\subsection{Byte Compiling Elisp Files}
\label{sec:byte-compile}

To decrease the time required to load and configure \xemacs\ you may
want to byte compile the Draco Elisp files.  This is an optional
step.  There is no requirement to compile these files since emacs will
evaluate the non-compiled elisp as needed.  Here are the steps to
follow to byte compile your elisp routines:

\begin{itemize}
\item Open your elisp directory in an \xemacs\ window (e.g.: C-x C-f 
$tilde$/lib/elisp).  This will open a directory listed in Dired mode.
\item Select all of the \texttt{.el} files. (\%e el).
\item Request \xemacs\ to compile the selected files (B y)
\end{itemize}

If you have any other custom code you may want to byte compile that
as well.

%%---------------------------------------------------------------------------%%

\section{Draco Templates}

A set of templates used by \draco\ resides in the
\comp{draco/templates/} directory.  These templates are used by the
functions described in \S~\ref{sec:func} to make \comp{.cc},
\comp{.tex}, and a host of other files.  Additional templates are
provided to help setup \draco\ packages quickly and easily.  \draco\ 
functions must be called under the \comp{draco/} (or \draco-like, ie.
\comp{milagro/} or \comp{dantev2/}) directory in order to use the
\draco\ templates.  This functionality is explained in
\S~\ref{sec:func}.  The template functions in \comp{tme-hacks} can be
used for work outside of \draco.

%%---------------------------------------------------------------------------%%

\section{Draco \C++ Indentation Style}

We have developed a \C++ indentation style for use in \draco.  The
style is called RTT and can be confirmed by querying the value of the
\comp{c-indentation-style} variable.  Figure~\ref{codeExample:samp1} gives an
example of the RTT indentation style.  
%% \cdFramedFigure{Test}{Example
%%  of the RTT \C++-indentation style.}  
By loading \comp{draco-rtt} in
the \comp{.emacs} file this indentation style is set automatically.

We note that there still exists a small bug in the \xemacs\ 
implementation of the \comp{namespace} keyword.  This will nominally
occur in definitions of functions within a \comp{namespace}.  To avoid
this error, we set the namespace indentation to zero.  Thus, the user
will not encounter this \xemacs\ \C++-mode bug when using the RTT
style.

% Contents of Test.hh
\begin{cxxSampleCode}
\begin{codeExample}
//---------------------------------------------------------------------------//
// Test of EMACS C++ Indentation Style
//---------------------------------------------------------------------------//

namespace rtt_test {

class Test
{
  private:
    // some data
    int x;
    double y;
    
  public:
    // constructor
    Test();
    
    // functions
    int get_x() { return x; }
    
    // inline functions
    template<class T> inline T do_something(T &);
};

// inline function
template<class T> T Test::do_something(T &x)
{
    double sum;
    for (int i = 0; i < x; i++)
    {
        x[i] += y;
        sum += x[i];
    }
    x.push_back(sum);
    
    // return the array-type
    return x;
}

} // end of namespace rtt_test

\end{codeExample}
\caption{Example of the RTT \C++-indentation style.}
\label{codeExample:samp1}
\end{cxxSampleCode}

%%---------------------------------------------------------------------------%%

\section{Draco Functions}
\label{sec:func}

This section describes two families of functions.  The first set,
\S~\ref{sec:dfunc}, is provided for use when developing in \draco\ 
only.  These functions must be used under a viable \draco-like system
directory such as \comp{draco/}, \comp{solon/}, or \comp{milagro/}.
The second set, \S~\ref{sec:gfunc} are general functions that may be
useful to \draco\ developers on projects outside of \draco.  These
function lists are highlights.  There exists additional functions that 
have limited, but useful, utility to various users.  See the packages
listed in Table~\ref{tab:elisp} for complete lists and descriptions of 
all functions.  

\subsection{Draco Functions}
\label{sec:dfunc}

The following is a list of functions used exclusively in \draco:
\begin{description}
\item[\comp{draco-package}:] Sets up the required files for a \draco\ 
  package including \comp{configure.in}, \comp{config.h.in},
  \comp{Version.hh}, and \comp{Version.cc}.
\item[\comp{draco-class}:] Sets up a \C++ class in \draco; makes a
  \textsl{class}\comp{.hh}, \textsl{class}\comp{.cc}, and a
  \textsl{class}\comp{.t.hh} file.
\item[\comp{draco-cc-head}:] Sets up a \C++ header file in \draco;
  makes a \textsl{header}\comp{.hh} file.
\item[\comp{draco-cc-headin}:] Sets up a \C++ header file in \draco\ 
  that is modified during configuration (see Ref.~\cite{draco-build});
  makes a \textsl{header}\comp{.hh.in} file.
\item[\comp{draco-c-head}:] Sets up a C header file in \draco; makes a 
  \textsl{header}\comp{.h} file.
\item[\comp{draco-c-headin}:] Sets up a C header file in \draco\ that
  is modified during configuration (see Ref.~\cite{draco-build});
  makes a \textsl{header}\comp{.h.in} file.
\item[\comp{draco-cc-imp}:] Sets up a \C++ implementation file unit;
  makes a \textsl{base}\comp{.cc} and \textsl{base}\comp{.t.hh} file.
\item[\comp{draco-python}:] Sets up a Python file; makes a
  \textsl{base}\comp{.py} file.
\item[\comp{draco-memo}:] Sets up a LANL-style memo using \LaTeX;
  makes a \textsl{name}\comp{.tex} file.
\item[\comp{draco-note}:] Sets up a LANL-style research note using
  \LaTeX; makes a \textsl{name}\comp{.tex} file.
\item[\comp{draco-article}:] Sets up a RTT-style article using \LaTeX;
  makes a \textsl{name}\comp{.tex} file.
\item[\comp{draco-report}:] Sets up a RTT-style report using \LaTeX;
  makes a \textsl{name}\comp{.tex} file.
\item[\comp{draco-bib}:] Sets up a \LaTeX\ BiB-\TeX\ file in RTT
  format; makes a \textsl{name}\comp{.bib} file.
\end{description}

Remember, these functions must be launched from a directory that is
located under \comp{draco/} or a \draco-like directory.  This is
required because the Elisp functions search up the directory-tree for
a \textsl{dir}\comp{/templates/} directory where templates are stored.
Thus, if a user is working in \comp{draco/src/c4/} and calls a \draco\ 
Elisp function then the directory will be searched upwards until
\comp{draco/templates/} is found.  Therefore, any system
directory-tree that uses the \draco\ model will accept the \draco\ 
Elisp functionality.

The user always has the option of making key-bindings for these
functions.  Key-bindings should be placed in the user's \comp{.emacs}
file or in a file in the \comp{elisp/} directory that is loaded from
\comp{.emacs}.  See \S~\ref{sec:.emacs} for examples.

\subsection{General Functions}
\label{sec:gfunc}

The following is a list of Elisp functions that are useful in
environments that supercede \draco.  This is a highlighted list of
functions that exist in the Elisp distribution described in
Table~\ref{tab:elisp}.  The easiest way to see the functions is to use
the \xemacs\ \comp{help-for-help A} function.  Query the strings
\comp{gmf}, \comp{rtt}, and \comp{tme} to see an almost complete list
of the functions defined in the \comp{elisp/} directory\footnote{Many
  of the interactive \comp{rtt-} prefixed functions are deprecated in
  the new build system.  These have been kept in the Elisp directory
  for reference and for working on previously tagged version of
  \draco.}.  Many of the functions that are prefixed by \comp{tme-}
use the \comp{\$HOME/lib/elisp/templates} directory as the default
location for templates.
\begin{description}
\item[\comp{rtt-find-companion-file}:] Finds the companion to a
  \comp{.hh} or \comp{.cc} file.
\item[\comp{rtt-insert-class-doc}:] Inserts a \C++-style class comment 
  block.
\item[\comp{rtt-insert-comment-divider}:] Inserts a \C++-style comment 
  divider.
\item[\comp{rtt-insert-function-doc}:] Inserts a \C++-style comment
  block divider.
\item[\comp{tme-latex-comment-divider}:] Inserts a \LaTeX-style comment
  divider.
\item[\comp{tme-latex-divider}:] Inserts a \LaTeX-style comment block 
  divider.
\item[\comp{tme-latex-radtran-dist}:] Inserts the distribution list of 
  the RTT (\draco) team for LANL memos and research notes.
\item[\comp{tme-latex-xtm-dist}:] Inserts the distribution list of XTM 
  for LANL memos and research notes.
\item[\comp{tme-c-comment-divider}:] Inserts a C-style comment
  divider.
\item[\comp{tme-c-divider}:] Inserts a C-style comment block divider.
\item[\comp{tme-m4-comment-divider}:] Inserts a M4-style comment
  divider.
\item[\comp{tme-m4-divider}:] Inserts a M4-style comment block
  divider.
\item[\comp{tme-makefile-comment-divider}:] Inserts a makefile-style
  (\comp{\#}) comment divider.  This is also useful in \comp{sh-mode},
  \comp{autoconf-mode}, and \comp{python-mode}.
\item[\comp{tme-makefile-divider}:] Inserts a makefile-style
  (\comp{\#}) comment block divider. This is also useful in
  \comp{sh-mode}, \comp{autoconf-mode}, and \comp{python-mode}.
\item[\comp{tme-\textsl{type}-file}:] Makes a template for the
  language \textsl{type}.  These are very similar to the \draco\ 
  functions described in \S~\ref{sec:dfunc}; however, these functions
  can be used anywhere, not just under \comp{draco/}.  Additionally,
  the template default location is \comp{\$HOME/lib/elisp/templates}.
\item[\comp{gmf-save-and-kill}:]  Saves a buffer and then kills it.
\end{description}  
A good example of how to incorporate these functions into Elisp
\comp{mode-hooks} is given in the file \comp{tme-keys}; see
\S~\ref{tme-keys}.

%%---------------------------------------------------------------------------%%

\pagebreak
\appendix

\section{Sample \comp{.emacs} File}
\label{.emacs}

This is a sample \comp{.emacs} file that loads the \draco\ development 
environment.  Additionally, this file loads user-defined options that
are stored in the \comp{.xemacs-options} and \comp{.xemacs-std}
files.  The \comp{.xemacs-options} file is written by the \comp{Save
  Options} command in the \xemacs\ \comp{Options} menu.  The
\comp{.xemacs-std} file is for preferences that the user does not want 
overwritten.  These options could easily be placed directly in the
\comp{.emacs} file if desired.  See the \xemacs\ \comp{Info} pages for 
more help.

\input{emacs}

\pagebreak
\section{Sample User Key-Bindings and Mode-Hooks}
\label{tme-keys}

This is a sample key-bindings and \comp{mode-hooks} file.  There are
many ways to achieve this type of functionality in \xemacs.  This file 
is one example.  See the \xemacs\ \comp{Info} pages for more help.

\input{tme-keys}

%%---------------------------------------------------------------------------%%

\pagebreak
\bibliographystyle{rnote}
\bibliography{../bib/draco}

\closing 
\end{document}

%%---------------------------------------------------------------------------%%
%% end of draco-emacs.tex
%%---------------------------------------------------------------------------%%
