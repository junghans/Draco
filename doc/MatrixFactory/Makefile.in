###############################################################################
# draco/doc/ Makefile
# Randy M. Roberts
# $Id$
###############################################################################
# @> Makefile for Matrix Factory (U)
###############################################################################

top_srcdir = @top_srcdir@
srcdir = @srcdir@

# get the relative directory between the top_srcdir and the srcdir

reldir := $(shell echo "${srcdir}" | sed s%${top_srcdir}%% | sed 's%/[^/]*%../%g')
ifeq (,${reldir})
  reldir := "."
endif

# get the relative directory to the config files (relative to ${top_srcdir}).

rel_config_dir := $(shell ( cd ${top_srcdir} ; \
	tmp="" ; \
	while test ! -d config ; \
	do \
	   cd .. ; \
	   tmp=$$tmp../ ; \
	done ; \
	echo $$tmp ) )config

##---------------------------------------------------------------------------##
## VARIABLES THAT ARE ASSIGNED BY AUTOCONF
## These are assigned using "="
##---------------------------------------------------------------------------##

VPATH = @srcdir@:@top_srcdir@:${reldir} # : this colon is a bug work around.

package = @package@
prefix = @prefix@
exec_prefix = ${prefix}
includedir = ${prefix}/include
libdir = ${exec_prefix}/lib
libexecdir = ${exec_prefix}/libexec
bindir = @bindir@

dirstoclean = @dirstoclean@

configure_command = @configure_command@

DRACO := ${srcdir}/../..
DRACOTEXINPUTS := ${DRACO}/doc/tex:.:${srcdir}
TEXINPUTSENVS := TEXINPUTS="${TEXINPUTS}:${DRACOTEXINPUTS}"

LATEXENVS := ${TEXINPUTSENVS}
LATEX := ${LATEXENVS} latex

BIBINPUTSENVS := BIBINPUTS="${TEXINPUTS}:${DRACOTEXINPUTS}"
BIBTEXENVS := ${BIBINPUTSENVS}
BIBTEX := ${BIBTEXENVS} bibtex

.PHONY : all install clean mostlyclean dvi postscript code

CXX2LATEX = c++2latex

postscript:

all: postscript code

postscript: matFactory.ps

dvi: matFactory.dvi

code:
	cd code; gmake

matFactory.ps: matFactory.dvi
	dvips -o matFactory.ps matFactory.dvi

hh_files := $(notdir $(wildcard ${top_srcdir}/code/*.hh))
cc_files := $(notdir $(wildcard ${top_srcdir}/code/*.cc))

cfgfiles := $(addsuffix .cfg, ${hh_files} ${cc_files})

matFactory.dvi: matFactory.tex matFactory.bib ${cfgfiles}
	${LATEX}  matFactory
	-${BIBTEX} matFactory
	${LATEX}  matFactory
	${LATEX}  matFactory

%.hh.cfg: code/%.hh
	${CXX2LATEX} -s 10 -n $< | \
	sed 's/\\em\>/\\cxxcom/g' | \
	sed 's/static_cast/static\\_cast/g' > $@

%.cc.cfg: code/%.cc
	${CXX2LATEX} -s 10 -n $< | \
	sed 's/\\em\>/\\cxxcom/g' | \
	sed 's/static_cast/static\\_cast/g' > $@

# Makefile depends on all of the M4 files in the config directory

configfiles := aclocal.m4 ac_local.m4 ac_conf.m4 ac_vendors.m4 ac_dracoarg.m4 \
 ac_dracoenv.m4 ac_compiler.m4
configfiles := $(addprefix ${top_srcdir}/${rel_config_dir}/, ${configfiles})

${top_srcdir}/configure: configure.in ${configfiles}
	cd ${top_srcdir} && autoconf --localdir=${rel_config_dir}

Makefile: Makefile.in config.status
	CONFIG_FILES=Makefile:Makefile.in \
		CONFIG_HEADERS= ./config.status

config.status: configure
	./config.status --recheck

mostlyclean: clean
	cd code; gmake clean

clean:
	-rm matFactory matFactory.o matFactory.int.c
	-rm *.ps *.dvi *.log *.aux *.bbl *.blg *.cfg
	-rm -r ${dirstoclean}
