%%---------------------------------------------------------------------------%%
%% no_cen_adj_7799.tex
%% Todd J. Urbatsch
%%---------------------------------------------------------------------------%%
\documentclass[10pt]{nmemo}
\usepackage[centertags]{amsmath}
\usepackage{amssymb,amsthm,graphicx}
\usepackage[mathcal]{euscript}
\usepackage{tmadd,tmath}
\usepackage{cite}
\usepackage{multicol}

%%---------------------------------------------------------------------------%%
%% DEFINE SPECIFIC ENVIRONMENTS HERE
%%---------------------------------------------------------------------------%%
%\newcommand{\elfit}{\ensuremath{\operatorname{Im}(-1/\epsilon(\vq,\omega)}}
%\msection{}-->section commands
%\tradem{}  -->add TM subscript to entry
%\ucatm{}   -->add trademark footnote about entry

%%---------------------------------------------------------------------------%%
%% BEGIN DOCUMENT
%%---------------------------------------------------------------------------%%
\begin{document}

%%---------------------------------------------------------------------------%%
%% OPTIONS FOR NOTE
%%---------------------------------------------------------------------------%%

\toms{Distribution}
%\toms{Joe Sixpak/XTM, MS B226}
\refno{XTM:99-49(U)}
\subject{Eliminating the Post-Comb Census Adjustment}

%-------NO CHANGES
\divisionname{Applied Theoretical \& Computational Physics Div.}
\groupname{X-TM:Transport Methods Group}
\fromms{Todd J. Urbatsch, Thomas M. Evans;\\ XTM, MS D409}
\phone{(505)667--3513, 665--3677 / 665--5538}
\originator{tju}
\typist{tju}
\date{July 13, 1999}
%-------NO CHANGES

%-------OPTIONS
%\reference{NPB Star Reimbursable Project}
%\thru{P. D. Soran, XTM, MS B226}
%\enc{list}      
%\attachments{list}
%\cy{list}
%\encas
%\attachmentas
%\attachmentsas 
%-------OPTIONS

%%---------------------------------------------------------------------------%%
%% DISTRIBUTION LIST
%%---------------------------------------------------------------------------%%

%% at bottom
%% \distribution {}

%%---------------------------------------------------------------------------%%
%% BEGIN NOTE
%%---------------------------------------------------------------------------%%

\opening

\begin{abstract}
  We describe recent changes to the census particle comb that ensure
  reproducibility in the MILAGRO and MILSTONE Implicit Monte Carlo
  (IMC) radiative transfer packages.  We discuss what was wrong with
  our modification to our census comb and what we need to do in the
  future.
\end{abstract}

\section{Introduction}

In order to make the IMC census particle comb reproducible, we
recognized that processor-dependent traits could not influence
individual particles~\cite{xtm:99022}.  As obvious as that statement
is, we nevertheless violated it.  The ensuing nonreproducibility only
occurred for a small number of particles and/or heterogeneous sources.
It also appears that our census comb could have introduced some bias
when there was intermittent unsampled census energy.

We shall briefly describe the history of our census particle comb, the 
error we made, the current fix, and the future plan.

\section{Reproducible Comb}

The purpose of combing the census particles is to control the number
of overall particles and maintain some equity in particle weights
(i.e., variance reduction).  Canfield produced a comb that conserved
energy exactly.  Unfortunately, it is not reproducible with varying
number of processors~\cite{ev98}.

We implemented a comb that essentially amounted to a splitting/Russian
roulette scheme.  In a cell, we know the census particle energy-weight
we want and what we have, so we sample an integer from the
want-to-have ratio and produce that many combed census particles.
Apart from the determination of ``wants'' and ``haves,'' each census
particle depends on no other particle and, thus, the comb is
reproducible with varying numbers of processors.  Unfortunately,
energy conservation is only statistical, and error propagation in time
could cause biases~\cite{ev98}.

\section{Post-Comb Census Weight Adjustment}

Desiring better energy conservation, we performed a post-comb
adjustment of the energy-weights.  This adjustment would conserve
census energy exactly, but {\em only on-processor}.  In Milagro, where 
the source is currently serial, this poses no problem.  In Milstone,
where the only processor topology is full domain decomposition, this
on-processor energy conservation poses no problem either.  

The problem was our additional constraint: we would perform the
post-comb census adjustment only if there was no unsampled census
energy.  Unsampled census energy could stem from too few particles or
a heterogeneous source.\footnote{The comb tries to make all census
  particles have about the same energy-weight, so a cell with low
  census energy may go unsampled.}  With Milagro's serial source,
again, there are no problems.  However, with Milstone, full domain
decomposition on varying numbers of processors could cause some
processors to see unsampled energy while other processors would not.
Thus, some processors would perform the post-comb census adjustment
while others would not, meaning that Milstone would not be
reproducible on varying numbers of processors.

Apart from reproducibility issues, the selective post-comb census
weight adjustment is probably biased.  It seems it would be negatively
biased to conserve energy exactly when there is no unsampled census
energy and only statistically when there is unsampled census energy.

\section{Current, Short-Term Corrections}

Our correction for now is to simply eliminate the post-comb census
weight adjustment.  The census energy conservation will be totally
stochastic, which may require tending toward a larger number of
particles.  This correction does, however, preserve reproducibility.

\section{Future Work}

As soon as we can, we will need to exactly conserve census energy with
the census comb.  Complications will arise when we move toward running
a parallel source in Milagro and when we implement a more general
topology (general replication/domain decomposition) in both Milagro
and Milstone.

We can deal with the complications by increasing the communication
between processors.  For each of its cells, a processor will need to
know the total census energy and the total number of post-comb census
particles.  Thus a potentially all-to-all communication is needed
after the combing.

Of course, a smarter algorithm beats brute force.  We will try to find 
an algorithm that does not require an all-to-all communication.


\bibliographystyle{rnote}
\bibliography{../../../milagro/doc/bib/IMC}

\begin{multicols}{2}[{\bf Distribution:}]
  Jim Morel, XTM, MS D409 \\
  Gordon Olson, XTM, MS D409\\
  Grady Hughes, XTM, MS D409\\
  Robert Weaver, XTA, MS B220\\
  Bernhard Wilde, XTA, MS B220\\
  Mike Clover, XCI, MS F663\\
  Mike Gittings, XCI, MS F663\\
  Kim Simmons, XCI, MS F663 \\
  Tom Evans, XTM, MS D409\\
  Todd Urbatsch, XTM, MS D409\\
  XTM Files\\
  XDO Files
\end{multicols}


\closing
\end{document}

%%---------------------------------------------------------------------------%%
%% end of no_cen_adj_7799.tex
%%---------------------------------------------------------------------------%%
