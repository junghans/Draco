%%---------------------------------------------------------------------------%%
%% expTraits.tex
%% Randy M. Roberts
%% $Id$
%%---------------------------------------------------------------------------%%
\documentclass[11pt]{nmemo}
\usepackage[centertags]{amsmath}
\usepackage{amssymb,amsthm,graphicx}
\usepackage[mathcal]{euscript}
\usepackage{tmadd,tmath}
\usepackage{cite}
\usepackage{c++}
\usepackage{fancycodes}
\usepackage[dvips]{color}

%%---------------------------------------------------------------------------%%
%% DEFINE SPECIFIC ENVIRONMENTS HERE
%%---------------------------------------------------------------------------%%
%\newcommand{\elfit}{\ensuremath{\operatorname{Im}(-1/\epsilon(\vq,\omega)}}
%\msection{}-->section commands
%\tradem{}  -->add TM subscript to entry
%\ucatm{}   -->add trademark footnote about entry

\definecolor{codecolor}{rgb}{0,0,1}
\definecolor{comcolor}{rgb}{1,0,0}
\newcommand{\cxxcom}{\color{comcolor}}
\newcommand{\cxxcode}{\color{codecolor}}

\newcommand{\code}[1]{\textcolor{codecolor}{#1}}

\newcommand{\tmpl}[1]{$<$#1$>$}

%%---------------------------------------------------------------------------%%
%% BEGIN DOCUMENT
%%---------------------------------------------------------------------------%%
\begin{document}

%%---------------------------------------------------------------------------%%
%% OPTIONS FOR NOTE
%%---------------------------------------------------------------------------%%

\toms{Distribution}
%\toms{Joe Sixpak/XTM, MS B226}
\refno{XTM-99-??? (U)}
\subject{Expression Engine Traits}

%-------NO CHANGES
\divisionname{Applied Theoretical \& Computational Physics Div.}
\groupname{X-TM:Transport Methods Group}
\fromms{Randy M. Roberts/XTM D409}
\phone{(505)665--4285}
\originator{rmr}
\typist{rmr}
\date{\today}
%-------NO CHANGES

%-------OPTIONS
%\reference{NPB Star Reimbursable Project}
%\thru{P. D. Soran, XTM, MS B226}
%\enc{list}      
%\attachments{list}
%\cy{list}
%\encas
%\attachmentas
%\attachmentsas 
%-------OPTIONS

%%---------------------------------------------------------------------------%%
%% DISTRIBUTION LIST
%%---------------------------------------------------------------------------%%

\distribution {}

%%---------------------------------------------------------------------------%%
%% BEGIN NOTE
%%---------------------------------------------------------------------------%%

\opening

\section{Introduction}

During the process of developing packages to be used with multiple host codes,
we have discovered competing requirements.
On the one hand we desire the host to supply containers (e.g.\ fields)
that encapsulate the storage and communication facilities.
On the other hand we would like services defined on those containers
that may be unique to our packages.
These services could include communications services, container-free hooks,
etc.
In order to use host-supplied containers that lack the desired services
we would have to provide those additional services ourselves.

What if the host-supplied containers already provide the desired services?
We would not want to interfere with the host's scheme for providing such
services.
Their implementation of the services could well be more suited to their
containers than anything that we would provide.

The traditional way to handle such situations is through a traits class
\cite{Austern99}\cite{Myers96}\cite{Furnish98}.
If the services can be wrapped around a \emph{dumb} container, then a traits
class can be employed to leave the container unaffected.
If the services are already provided by an \emph{enlightened} container, then
a traits class that does nothing can be used to do no wrapping.

\section{Expression Engine Traits}

In this particular memo the desired services are that the containers
be {\em expression enabled}, i.e.\ that they can be used in expressions of the
form
\begin{equation}
  \label{eq:expression}
  c3 = \mbox{asin}(c1) + 3.0*c2;
\end{equation}

\subsection{expTraits.cc}

In this section we display a test code that uses expressions
on containers.
The \code{doit} function is templated on a
\code{Container} type.
It then creates and uses containers of this type within expressions.
It uses the containers within expressions through the use of
the expression engine traits class, \code{ExpEngineTraits\tmpl{Container}}.

The \code{main} function calls
\code{doit()} with template arguments
\code{std::vector\tmpl{double}} and \linebreak
\code{UserVec\tmpl{double}}.
The container \code{std::vector\tmpl{double}} does not provide expression
services,
whereas the container
\code{UserVec\tmpl{double}} does provide expression
services.
In both cases \code{doit} treats the containers identically, through the traits
class.

The following file is \texttt{expTraits.cc}.
This is the test code that demonstrates the use of the expression engine traits class.

\begin{ttfamily}
\begin{small}
\cxxcode
\input{expTraits.cc.cfg}
\end{small}
\end{ttfamily}

\subsection{expTraits.hh}

A decision must be made about the functionality of the \emph{default} traits
class.
In our case we decided that the \emph{default} traits class would \emph{glom}
our own expression template engine,
\code{XM}, onto the container\cite{Furnish97}.
If we wanted to use an \emph{enlightened} container with the \code{doit}
function, then we must override the default traits class with a \emph{specialized}
traits class that would allow the enlightened behavior of the class to
shine through.

The default expression engine traits class contains a nested class,
\code{ERCT}, that
acts as an adaptor that wraps \code{XM} around a dumb random access
container, \code{RCT}\cite{Austern99}\cite{Furnish98}.
In a twist on the method used in reference \cite{Furnish98},
the adaptor inherits from both \code{RCT}, and
the classes necessary to implement \code{XM},
instead of merely containing a reference to the dumb random access container.
This twist was developed in order to use nested class
references to the dumb random access instantiations as 
if they were both expression-enabled objects and the original objects.
These nested class references would perform the expression activities \emph{on}
instantiations of the dumb random access class.
A typedef is provided for the nested class, \code{ExpEnabledContainer},
though the nested class could have used the name instead.
The reason for the typedef is to reveal the similarities in the traits
used for \emph{dumb} and \emph{enlightened} classes.

The trait's static method, \code{Glom}, serves to convert an instance
of the dumb random access container to a nested class reference.
The references are then used in expressions as desired.

The following file is \texttt{expTraits.hh}.
This file defines the default expression engine traits class that
should be used for \emph{dumb}
random access containers.

\begin{ttfamily}
\begin{small}
\cxxcode
\input{expTraits.hh.cfg}
\end{small}
\end{ttfamily}

\subsection{UserVec.hh}

The following file is \texttt{UserVec.hh}.
This file defines a \emph{enlightened} container, \code{UserVec},
that already has expressions enabled\cite{Furnish97}.

\begin{ttfamily}
\begin{small}
\cxxcode
\input{UserVec.hh.cfg}
\end{small}
\end{ttfamily}

\subsection{UserVecTraits.hh}

We want to use the \code{UserVec} class in expressions, just as we would use
a \emph{glommed dumb} container.
We want to do so without subverting the expression
mechanism already within \code{UserVec}.
To accomplish this goal we need to create a specialization of the
\code{ExpEngineTraits} class.

The code for this specialization is displayed in \texttt{UserVecTraits.hh}.
This file demonstrates the partial specialization of \code{ExpEngineTraits}
on \code{UserVec\tmpl{T}}.

This specialization of \code{ExpEngineTraits} defines the nested type,
\code{ExpEnabledContainer}, to be merely the container itself, \code{UserVec}.
The \code{Glom} method simply returns a reference to a \code{UserVec},
effecting a No-Op operation.

\begin{ttfamily}
\begin{small}
\cxxcode
\input{UserVecTraits.hh.cfg}
\end{small}
\end{ttfamily}

\section{Putting it all together}

When the \code{doit} function is invoked with a \emph{dumb} container,
which is
a container that has not had \code{ExpEngineTraits} specialized, then
the default version of the \code{ExpEngineTraits} class is used to obtain
the \code{ExpEnabledContainer} nested class and the \code{Glom} static method.
The combination of these two entities serves to wrap the container in
an \code{XM} adaptor.
The reference returned from \code{Glom} may be used within expressions, the
results of which will affect the original container.

When the \code{doit} function is invoked with an \emph{enlightened} container,
which is
a container that has had \code{ExpEngineTraits} specialized, then
the specialized version of the \code{ExpEngineTraits} class is used to obtain
the \code{ExpEnabledContainer} nested class and the \code{Glom} static method.
The combination of these two entities serve to merely return references
to the original container.
The reference returned from \code{Glom} may be used within expressions, the
results of which will affect the original container, since the reference
\emph{is} just for the original container.

\bibliographystyle{apalike}

\bibliography{expTraits}

\closing
\end{document}

%%---------------------------------------------------------------------------%%
%% end of expTraits.tex
%%---------------------------------------------------------------------------%%
