%  ========================================================================  %
% 
% 	Author:	Mark G. Gray
% 		Los Alamos National Laboratory
% 	Date:	Wed Apr  5 09:42:35 MDT 2000
% 
% 	Copyright (c) 2000 U. S. Department of Energy. All rights reserved.
% 
%  	$Id$
% 
%  ========================================================================  %

\documentclass[11pt]{nmemo}
\usepackage{amssymb,amsthm,graphicx}

%%---------------------------------------------------------------------------%%
%% BEGIN DOCUMENT
%%---------------------------------------------------------------------------%%

\newcommand{\fninety}{\texttt{Fortran~90}}
\newcommand{\cpp}{\texttt{C++}}
\newcommand{\withfninety}{\texttt{--with-f90}}
\newcommand{\fninetyenv}{\texttt{AC\_F90\_ENV}}
\newcommand{\langfninety}{\texttt{AC\_LANG\_FORTRAN90}}
\newcommand{\progfninety}{\texttt{AC\_PROG\_F90}}
\newcommand{\requiregmfour}{\texttt{AC\_REQUIRE\_GM4}}
\newcommand{\proggmfour}{\texttt{AC\_PROG\_GM4}}
\newcommand{\fseventyseven}{\texttt{Fortran 77}}
\newcommand{\langc}{\texttt{AC\_LANG\_C}}
\newcommand{\langcplusplus}{\texttt{AC\_LANG\_CPLUSPLUS}}
\newcommand{\langfseventyseven}{\texttt{AC\_LANG\_FORTRAN77}}
\newcommand{\progcc}{\texttt{AC\_PROG\_CC}}
\newcommand{\progcxx}{\texttt{AC\_PROG\_CXX}}
\newcommand{\progfseventyseven}{\texttt{AC\_PROG\_F77}}
\newcommand{\langsave}{\texttt{AC\_LANG\_SAVE}}
\newcommand{\langrestore}{\texttt{AC\_LANG\_RESTORE}}
\begin{document}

%%---------------------------------------------------------------------------%%
%% OPTIONS FOR NOTE
%%---------------------------------------------------------------------------%%

\toms{Distribution}
\refno{X6:00--20 (U)}
\subject{\fninety\ Build Support in Draco}
\divisionname{Applied Physics Division}
\groupname{X--6:Transport Methods Group}
\fromms{Mark G. Gray/MS D409}
\phone{(505)667--5341}
\originator{mgg}
\typist{mgg}
\date{April 25, 2000}

%%---------------------------------------------------------------------------%%
%% DISTRIBUTION LIST
%%---------------------------------------------------------------------------%%

\distribution {
  J.E. Morel, X--6 MS D409\\
  J.M. McGhee, X--6 MS D409\\
  H.G. Hughes, X--6 MS D409\\
  H.   Lichtenstein, X--6 MS D409\\
  T.M. Evans, X--6 MS D409\\
  M.L. Murillo, X--6 MS D409\\
  S.D. Pautz, X--6 MS D409\\
  R.M. Roberts, X--6 MS D409\\
  T.J. Urbatsch, X--6 MS D409\\
  T.A. Wareing, X--6 MS D409\\
  J.S. Warsa, X--6 MS D409\\
  C.J. Gesh, X--6 MS D409\\
  W.D. Hawkins, X--6 MS D409\\
  B.T. Adams, X--6 MS D409 \\
  M.L. Alme, X--6 MS D409\\
  J.C. Gulick, X--6 D409\\
  K.G. Thompson, X--6, MS D409\\
  R.B. Lowrie, X--3 MS D413\\
  R.B. Webster, X--11, MS F663 
  }

%%---------------------------------------------------------------------------%%
%% BEGIN NOTE
%%---------------------------------------------------------------------------%%

\opening

% I want to tell John that...

I have added rudimentary \fninety\ support to the Draco build
system\cite{draco-build}.  The autoconf\cite{autoconf} macros in
\texttt{draco/config} now support the \withfninety\ argument, which
allows the user to specify the \fninety\ compiler to use; the
\fninetyenv\ macro, which sets \fninety\ environment variables; the
\langfninety\ macro, which sets \fninety\ compile and link tests; and
the \progfninety\ macro, tests the selected compiler.  These features
provide basic functionality for configuring a \fninety\ package.  They
form the beginnings of \fninety\ support in Draco, provide a template
for other language support in Draco, and suggest a possible
refactoring of the existing build macros.

\section{Background}

Draco was originally concieved as a collection of \cpp\ packages that
could be used to construct transport codes.  An unexpected bonus of
the Draco project was a build system, based on autoconf, that could be
used to configure any collection of \cpp\ code for various platforms.
After several iterations of careful planning and hard work, the Draco
build system appears simple to its users and has proven robust in its
operation.

One feature missing from the build system was support for \fninety.
Although Draco will remain primarily a \cpp\ repository, \fninety\
interface packages, numerical packages, and vendor packages are
planned additions.  Further, just as the build system in Draco is
reused in other \cpp\ projects, a common build system that could be
reused by other \fninety\ projects is desirable.

I had written rudimentary \fninety\ support as part of the Zathras and
Centauri projects.  This support was based on the autoconf macros
written for Dante by Randy Roberts.  With the advent of the new Linux
workstations and Fujitsu compiler I needed to at least revisit my old
\fninety\ autoconf macros.  This seemed to be an ideal time to look
into incorporating that \fninety\ support in Draco.

I examined Tom Evans work on the autoconf \cpp\ macros for the build
system, and found the design sound and highly ameanable to the
necessary \fninety\ additions.  This memo documents the addition of
several necessary build system features for \fninety\ support.

\newpage

\section{Introduction}

How should the Draco build system support \fninety?  Ideally the user
should see a set of \fninety\ specific macros that work just like
autoconf's support for other languages.  The solution should be
backwards compatible; existing Draco configuration files should
continue to work.  In this section I will examine how the autoconf
works for supported languages, how the Draco build system works for
\cpp, the problems involved with applying this approach to \fninety,
and the resolution of these problems.

Autoconf (version 2.13) supports the \texttt{C}, \cpp, and
\fseventyseven\ programming languages.  Its native support works as
follows:
\begin{itemize} 
\item A language is selected with the macros \langc, \langcplusplus,
or \langfseventyseven.  These macros create compile and link lines,
which are parameterized by compiler, compiler flag, and load flag
environment variables.
\item The compiler availability and viability are tested by the macros
\progcc, \progcxx, or \progfseventyseven.  These macros push the
current language on a stack using \langsave, call the appropriate
\texttt{AC\_LANG\_X} macro (see above), set the name of a compiler to
use if it is not set in the environment, test the compiler using the
compile and link lines specified on a simple test program, and restore
the original language from the stack using \langrestore.
\end{itemize}
Although the user may test specific compilers by setting the
appropriate environment variables, the compiler tests for \texttt{C},
\cpp, and \fseventyseven\ can be made without knowledge of the
specific vendor because these compilers are remarkably uniform across
UNIX platforms.  For example the default \texttt{C} link test,
\texttt{cc -g conftest.c}, will produce a working \texttt{C} program
on virtually every UNIX platform in existance.

The use of a stack in \texttt{AC\_PROG\_X} provides supports for
multi-language configurations.  The \texttt{configure.in} file
snippet:
\begin{verbatim}
AC_PROG_CC
AC_PROG_CXX
AC_PROG_F77
\end{verbatim}
finds, sets, and tests \texttt{C}, \cpp, and \fseventyseven\ compilers,
respectively.

The Draco build system adds an additional step: a specific \cpp\
compiler is requested by the configure argument \texttt{--with-cxx},
and compiler specific flags are set by the macro
\texttt{AC\_DRACO\_ENV}.  This additional step requires that autoconf
know something about specific compilers; this database is kept in the
file \texttt{ac\_compilers.m4}.  The disadvantage of giving autoconf
this specific knowledge is that it must be maintained; the advantage
is that \progcxx\ can check if the user requested flags
work, and the build system can use simpler makefile templates.

Basic autoconf language support can be extended to \fninety\ by:
\begin{itemize}
\item Modifying its \texttt{C} and \cpp\ centric macros (\langrestore\
and \texttt{AC\_TRY\_COMPILER}) to support other languages (this is
already kludged in 2.13 for \fseventyseven)
\item Writing a \langfninety\ macro to set \fninety\ compile and link
lines for testing
\item Writing a \progfninety\ macro to test the availability and
viability of the \fninety\ compiler
\end{itemize}
Unfortunately \fninety\ compilers are not very uniform across
platforms, so any guess that \progfninety\ makes for compile and link
lines is likely not to work across platforms.  

Fortunately, the Draco additions provide a solution; set up compiler
specific flags before testing the compiler.  Basic Draco build support
can be extended to \fninety\ by:
\begin{itemize}
\item Adding a \withfninety\ argument to select the \fninety\ compiler
\item Writing a \texttt{AC\_WITH\_F90} macro to set \texttt{with\_f90}
to ``yes'' if it isn't already set
\item Writing a \fninetyenv\ macro to set \fninety\ environment
variables
\end{itemize}

The plan, then, is to add two autoconf macro files to the Draco build
system in \texttt{draco/config}:
\begin{description}
\item[\texttt{ac\_f90.m4}:] \fninety\ compiler support macros
\item[\texttt{ac\_f90env.m4}:] \fninety\ environment support macros
\end{description}
This solution achieves several desirable effects.  First, the
additions to autoconf's compiler support through \texttt{ac\_f90.m4}
are consistent with its native compiler support.  Second, the
additions to Draco's compiler support through \texttt{ac\_f90env.m4}
are consistent with its native environment configuation.  Third, these
additions do not change existing Draco clients.  Finally, the user
sees a simple configuration; the work and complexity are hidden in the
build system macros.

\section{\fninety\ Compiler Support}

The file \texttt{ac\_f90.m4} contains two macros for \fninety\
compiler support:
\begin{description}
\item[\langfninety:] set the compile and link test invocation using
\texttt{F90}, \texttt{F90FLAGS}, and \texttt{LDFLAGS}.  This macro is
based on the \langc, \langcplusplus, and \langfseventyseven\ macros in
\texttt{acgeneral.m4}.
\item[\progfninety:] test the \fninety\ compiler to use.  Set the
following environment variables:
\begin{description}
\item[\texttt{F90}:] name of a working \fninety\ compiler.
\item[\texttt{MODNAME}:] vendor specific module file name.  Module
files containing interface information are generated by the compiler
when a file containing a module is found.  Module files may be named
after the file containing the module, or after the module name, in
either all caps, all lowercase, or mixed case.  Use a compile test to
determine which is the case.   
\item[\texttt{MODSUFFIX}:] vendor specific module extension name.
Module files may have extension \texttt{mod}, \texttt{M}, \texttt{o}
(i.e. be part of the object file), or something else.  Use a compile
test to determine which is the case.
\end{description}
This macro is based on the \progcc, \progcxx, and \progfseventyseven\
macros in \texttt{acspecific.m4}.
\end{description}

These macros have been tested on a limited number of machines.
\progfninety\ can fail due to vendor non-standard file extentions or
incorrect free/fixed source defaults.  Output variables are correctly
set for a few known targets.  As with other autoconf macros, any
file named [Cc]onftest* will be overwritten!

\section{\fninety\ Environment Support}

The file \texttt{ac\_f90env.m4} contains two macros for \fninety\
environment support:
\begin{description}
\item[\texttt{AC\_WITH\_F90}:] set the variable \texttt{with\_f90} to
``yes'' if it is not already set.
\item[\fninetyenv:] set the following \fninety\ environment variables:
\begin{description}
\item[\texttt{F90}:] name of an executable \fninety\ compiler.
\item[\texttt{F90FLAGS}:] vendor specific default flags for the
\fninety\ compiler.  Changes appropriately according to the
\texttt{--enable-debug} and \texttt{--with-opt} configure arguments.
\item[\texttt{F90EXT}:] vendor specific extension of \fninety\ input files.
\item[\texttt{F90FREE}:] vendor specific flag to specify free form
source input. 
\item[\texttt{F90FIXED}:] vendor specific flag to specify fixed form
source input. 
\item[\texttt{MODFLAG}:] vendor specific module include directory
flag, typically \texttt{-I} or \texttt{-M}.
\end{description}
\end{description}

The \fninety\ compiler can be specified by giving the \withfninety\ 
argument to configure.  The supported compilers are shown in
Table~\ref{tbl:compilers}.
\begin{table}[htb]
\hrulefill
\begin{center}
\caption{Supported \fninety\ compilers}\label{tbl:compilers}
\begin{tabular}{l|l|l|l}
Compiler        & Executable & Target  & Target \\
(\withfninety=) & File       & OS      & Platform \\ \hline
Fujitsu         & f90        & Linux   & ix86 \\
XL	        & xlf90      & AIX     & RS6000 \\
WorkShop        & f90	     & Solaris & Sparc \\
Cray            & f90        & UNICOS  & Y-MP \\
MIPS            & f90        & IRIX    & SGI  
\end{tabular}
\end{center}
\hrulefill
\end{table}
If \withfninety\ is given without any arguments, the compiler is set
based on the target.  The compiler is verified by running
\texttt{\$F90 --version} (or its equivalent) and checking the output
for the product name.

A new compiler can be adding a database entry for it, adding it to the
case statement in \fninetyenv, and adding it to the argument option
string of \withfninety, all in the file \texttt{ac\_f90env.m4}. The
\withfninety\ argument is based on the \texttt{--with-cxx} argument in
\texttt{ac\_dracoarg.m4}.

\section{Example Fortran 90 Configuration}

\begin{figure}[hbt]
\hrulefill
\begin{verbatim}
AC_INIT(acf90)                  dnl process args; verify src dir
AC_CONFIG_AUX_DIR(../../config) dnl config.sub, config.guess, install-sh

AC_F90_ENV                      dnl configure the Fortran 90 environment
AC_LANG_F90                     dnl find and test Fortran 90 compiler 

AC_OUTPUT(Makefile)             dnl create output files
\end{verbatim}
\caption{Sample \texttt{configure.in}.}\label{fig:configure}
\hrulefill
\end{figure}

Figure~\ref{fig:configure} shows a sample \texttt{configure.in} using
the \fninety\ macros.  The preamble lines initialize autoconf, give it
a file to check to verify that it is using the proper source
directory, and specify where to find the common scripts needed by
configure.  

The \texttt{config.sub}, \texttt{config.guess}, \texttt{install-sh},
and aclocal files autoconf uses to create \texttt{configure} from
\texttt{configure.in} are kept in the \texttt{config/} directory.
Figure~\ref{fig:zathras} shows the CVS module entry for Zathras, which
instructs \texttt{cvs~checkout~Zathras} to creates the directory
\texttt{zathras}, populate it with the contents of
\texttt{\$CVSROOT/zathras} and \texttt{\$CVSROOT/draco/config}, with
the latter renamed to \texttt{zathras/config}.  This is the standard
way to import the Draco build macros in external project directories.
\begin{figure}[hbt]
\hrulefill
\begin{verbatim}
# Zathras and friends:

Zathras         -a zathras zathras_config
zathras_config  -d zathras/config draco/config
\end{verbatim}
\caption{CVS module entry for Zathras.  The configure files for the
Draco build system located in \texttt{\$CVSROOT/draco/config} are put
into the \texttt{zathras/config} directory on
checkout.}\label{fig:zathras}
\hrulefill
\end{figure}

The body of Figure~\ref{fig:configure} contains the macros for
\fninety\ support.  \texttt{AC\_F90\_ENV} processes configure
arguments, including the selection of \fninety\ compiler based on
either the \withfninety\ argument or the target platform and flags
based on the \texttt{--enable-debug} and \texttt{--with-opt}
arguments.  \progfninety\ tests  the compiler to make sure it can
compile a null program, and discovers how to handles modules.

The last line processes \texttt{Makefile.in} to produce a
\texttt{Makefile} with the appropriate variable substitutions made.

The \fninetyenv\ macro is invoked by \texttt{AC\_DRACO\_ENV} if
\texttt{with\_f90} is set.  An appropriate \texttt{configure.in} for a
Draco \fninety\ package is given in Figure~\ref{fig:configure2}.
\begin{figure}[hbt]
\hrulefill
\begin{verbatim}
AC_INIT(acf90)                  dnl process args; verify src dir
AC_CONFIG_AUX_DIR(../../config) dnl config.sub, config.guess, install-sh

AC_WITH_F90                     dnl ensure with_f90 set
AC_DRACO_ENV                    dnl configure the Draco environment
AC_LANG_F90                     dnl find and test Fortran 90 compiler 

AC_OUTPUT(Makefile)             dnl create output files
\end{verbatim}
\caption{Sample Draco \texttt{configure.in}.}\label{fig:configure2}
\hrulefill
\end{figure}
This configure file does everything that the file shown in
Figure~\ref{fig:configure} does; in addition it sets the flags and
features that are standard in the Draco build environment.

Figure~\ref{fig:makefile} shows a test \texttt{Makefile.in} that
illustrates the use of the \fninety\ variables.  
\begin{figure}[phbt]
\hrulefill
\begin{verbatim}
# Macro Definitions

MODSUFFIX       =       @MODSUFFIX@
MODNAME         =       @MODNAME@
MODFLAG         =       @MODFLAG@

F90             =       @F90@
F90FLAGS        =       @F90FLAGS@
F90EXT          =       @F90EXT@
F90FREE         =       @F90FREE@
F90FIXED        =       @F90FIXED@
GM4             =       @GM4@

# Dependency and commands

all:
        @echo "F90       = ${F90}"
        @echo "F90FLAGS  = ${F90FLAGS}"
        @echo "F90EXT    = ${F90EXT}"
        @echo "F90FREE   = ${F90FREE}"
        @echo "F90FIXED  = ${F90FIXED}"
        @echo "MODNAME   = ${MODNAME}"
        @echo "MODSUFFIX = ${MODSUFFIX}"
        @echo "MODFLAG   = ${MODFLAG}"
        @echo "GM4       = ${GM4}"
\end{verbatim}%$
\caption{Sample Makefile.in.  The macro definitions (rhs) are expanded
by the configure script resulting from processing the configure.in
given in Figure~\ref{fig:configure}.  The single target prints the
resulting definitions.}\label{fig:makefile} \hrulefill
\end{figure}

Running autoconf on the \texttt{configure.in} file from
Figure~\ref{fig:configure} and running the resulting
\texttt{configure} file in a directory containing the test
\texttt{Makefile.in} produces a \texttt{Makefile} which, when executed,
produces the output in Figure~\ref{fig:make}.
\begin{figure}[phbt]
\hrulefill
\begin{verbatim}
azathoth $ make
F90       = f90
F90FLAGS  = -O0 -X9 -Am
F90EXT    = f90
F90FREE   = -Free
F90FIXED  = -Fixed
MODNAME   = modname
MODSUFFIX = mod
MODFLAG   = -I
GM4       = m4
\end{verbatim}%$
\caption{Result of sample make on azathoth (a Linux
machine).  The compiler is named f90.  The flags specify level 0
optimization, \fninety\ standard, and module generation.  The proper
file extension is .f90.  Free and fixed source are specified with
-Free and -Fixed, respectively.  Module files are named after the
module, with extension .mod.  Module include directories are specified
with -I.  GNU m4 was found, under the name m4.}\label{fig:make}
\hrulefill
\end{figure}

\section{Conclusion}

I have written autoconf macros that provide rudimentary \fninety\
support for the Draco build system.  For \cpp\ clients, nothing in the
build system is affected.  For \fninety\ clients these macros set
environment variables for \fninety, find an appropriate \fninety\
compiler, verify its operation, and set the flags needed for its use
as a makefile command.

Much work remains.  A standard \texttt{Makefile.in}
for \fninety\ source directories, and a tool for ordering dependencies
within and perhaps across directories is needed before Draco truely
supports \fninety\ builds.  

The \texttt{AC\_WITH\_F90}, \fninetyenv, \langfninety, and
\progfninety\ macros provide templates for adding other language
support in Draco.  In theory a single \texttt{configure} file could
select and configure for several languages, permitting the use of
mixed language directories in Draco.  However, this has not been
tested; current plans are for all Draco components (directories) to be
unilingual.
 
Future language support, including improved support for \fninety,
could be made easier by refactoring the Draco build system.  For
example, \texttt{AC\_DRACO\_ENV} should be rewritten so that it only
sets environment variables (perhaps using \texttt{AC\_CHECK\_PROGS} to
search for compilers); the autoconf macros that test for compilers
should be called explicitly after the environment variables are set.
With this change a Draco multi-language \texttt{configure.in} could look
like this:
\begin{verbatim}
AC_WITH_PYTHON                  dnl ensure with_python set
AC_WITH_F90                     dnl ensure with_f90 set
AC_WITH_CXX                     dnl ensure with_cxx set
AC_WITH_CC                      dnl ensure with_cc set
AC_DRACO_ENV                    dnl configure Draco build environment
AC_PROG_CC                      dnl find and test C compiler
AC_PROG_CXX                     dnl find and test C++ compiler
AC_PROG_F90                     dnl find and test Fortran 90 compiler
AC_PROG_PYTHON                  dnl find and test Python interpreter
\end{verbatim} 
Additionally, \texttt{AC\_DRACO\_ENV} should be factored into
environments macros for individual tools, e.g. \texttt{AC\_CXX\_ENV},
\texttt{AC\_CC\_ENV}, \texttt{AC\_PYTHON\_ENV}, and \fninetyenv.  This
would permit easy use parts of the Draco build system in other
projects.  For example, Zathras could define a macro
\texttt{AC\_ZATHRAS\_ENV} in the file
\texttt{zathras/pkg\_config/ac\_pkg.m4} which would consist of, say,
\fninetyenv\ and \texttt{AC\_PYTHON\_ENV}.  Zathras's \texttt{configure.in}
could then look like this:
\begin{verbatim}
AC_ZATHRAS_ENV                  dnl configure Python, Fortran 90
AC_PROG_F90                     dnl find and test Fortran 90 compiler
AC_PROG_PYTHON                  dnl find and test Python interpreter
\end{verbatim}

This could simplify build macros, make the build system less
\cpp-centric, increase the possibility of having one template
\texttt{Makefile.in} serve all, and make the build system more usable
by projects outside of Draco.

\bibliographystyle{plain}
\bibliography{../bib/draco}
\clearpage
\closing

\end{document}

%  ========================================================================  %
