#! /bin/sh
##---------------------------------------------------------------------------##
## launchtest
## Thomas M. Evans, Draco Project Team
## $Id$
##---------------------------------------------------------------------------##
## A script to launch regression tests through dejagnu.  The options
## passed to launchtest are set by configure.  Launchtest launches
## programs using the following format:
##
##   launchtest --${exe_type} --${parallel} ${executable} ${exe_options}
## 
## where:
##       ${exe_type} is the executable format; python and binary
##                   are currently supported
##       ${parallel} is the parallel setup; --mpi n and --shmem n,
##                   where n is the number of processors are 
##                   currently supported
##       ${executable} is the executable name
##       ${exe_options} are any command-line options passed to the
##                      executable (ie. --version)
##
## thus, launchtest --python --mpi 3 /user/local/bin/x translates to:
##
##   python /user/local/bin/x --procs 3 2>&1
##
## For a binary, launchtest --binary --mpi 2 /usr/local/bin/exe -i testin
## translates to:
##
##   mpirun -np 2 /usr/local/bin/exe -i testin 2>&1
##
## This script is for the sole purpose of running dejagnu regression
## tests, the executable type can be set in configure.in by the
## AC_TESTEXE() macro; binary is the default.  The parallel and 
## exe_options are set by configure.  Additional executable formats
## are easily added by modifying this script.  Thus, to add perl, we 
## simply have to add to this script and not to the ac_dracoenv.m4.
##---------------------------------------------------------------------------##
prefix=@prefix@
exec_prefix=@exec_prefix@
libexecdir=@libexecdir@

##---------------------------------------------------------------------------##
## variable definitions for parsing the command line

exe='binary'
mpi='no'
procs='scalar'
next='option'
parallel='no'

##---------------------------------------------------------------------------##
## SYSTEM
host=`uname`
sandiasys=`echo $SNLSYSTEM` 

##---------------------------------------------------------------------------##
## Setting up rmpool for AIX machines (up/purple)
if test "$host" = 'AIX' ; then
    mach=`uname -n`
    mach_name=`echo ${mach} | sed 's/[0-9].*//'`
    if test "$mach_name" = 'up' ; then
       pool='pdebug'
    else
       pool='viz'
    fi
fi

##---------------------------------------------------------------------------##
## MPI EXECUTABLE

##---------------------------------------------------------------------------##
## command line actions

for variable in $*
    do
    
    # assign variables
    if test "$next" = 'proc' ; then
	procs=$variable
	next='option'
    elif test "$next" = 'exe_options' ; then
	exe_options="${exe_options} ${variable}"
    elif test "$variable" = '--python' ; then
	exe='python'
    elif test "$variable" = '--binary' ; then
	exe='binary'
    elif test "$variable" = '--np' ; then
	exe='binary'
        parallel='application'
        next='proc'
    elif test "$variable" = '--mpi' ; then
	mpi='yes'
	parallel='yes'
	next='proc'
    else
	executable=$variable
	executable_name=`echo ${variable} | sed -e 's/.*[/]//' | sed -e 's/[.].*//'`
	next='exe_options'
    fi
done

##---------------------------------------------------------------------------##
## translate the executable line

case $exe in

    # python executable
    python)
        if test "$parallel" = 'no' ; then

            test_exec="python $executable --scalar $exe_options"

        elif test "$parallel" = 'yes' ; then

            test_exec="python $executable --procs $procs $exe_options"

        fi
    ;;

    # binary
    binary)
        if test "$parallel" = 'no' ; then

           if test "$host" = 'AIX' ; then 
              test_exec="$executable $exe_options -rmpool $pool"
	   elif test "$sandiasys" = "redstorm"; then
	      test_exec="yod -np 1 $executable $exe_options"
           else
              test_exec="$executable $exe_options"
           fi

        elif test "$parallel" = 'application'; then

            test_exec="$executable --np $procs $exe_options"

        elif test "$parallel" = 'yes'; then

            # different parallel implementations
            if test "$mpi" = 'yes'; then

                # we must parse on different host types here
                case $host in

                    # IBM AIX (with poe)
                    AIX)
                        test_exec="poe $executable $exe_options -procs $procs -rmpool $pool -retry 1"
                    ;;
                    
                    # COMPAQ
                    OSF1)
                        test_exec="prun -n $procs $executable $exe_options"
                    ;;

		    # Linux, lambda and non-lambda
		    Linux)
			mpich_path=`which mpirun 2>/dev/null | sed -e "/mpich/!d"`
			aprun_path=`which aprun 2>/dev/null`
			if test "$LSB_SUB_HOST" = "lambda" && test $mpich_path; then
			    test_exec="$libexecdir/mpijob -v mpirun -np $procs $executable $exe_options"
			elif test "$sandiasys" = "redstorm"; then
			    test_exec="yod -np $procs $executable $exe_options"
			elif test $aprun_path; then
			    test_exec="aprun -n $procs $executable $exe_options"
			else
			    test_exec="mpirun -np $procs $executable $exe_options $number"
			fi
		    ;;

                    # all other standard MPI implementations
                    *)
                        test_exec="mpirun -np $procs $executable $exe_options $number"
                    ;;
                esac

            fi

        fi
    ;;

    # unspecified
    *)
        echo "No valid executable type specified!"
        exit 1
    ;;

esac

##---------------------------------------------------------------------------##
## Give message about executable

echo "****************************************"
echo "* TEST RUN HEADER"
echo "*"
echo "* Name       : $executable_name"
echo "* Processors : $procs"
echo "* Type       : $exe"
echo "****************************************"
echo "********* PROBLEM OUTPUT BELOW *********"
echo 

##---------------------------------------------------------------------------##
## execute the test

exec $test_exec 2>&1
