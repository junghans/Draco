#%Module
# vi:set filetype=tcl:

# This file is based on the module file for ML's OpenMPI/1.6.3:

# where are we? 
# trim everything after ':'
set module_path $::env(MODULEPATH)
set darwin_module_dir [ lindex [ split "$module_path" ":" ] 0 ]
cd $darwin_module_dir/..
set draco_module_dir [pwd]

source $draco_module_dir/templates/header

# local variables
set name        [moduleName]
set version     [moduleVersion]
set machine     [machineName]

# module whatis
module-whatis   "LAPACK $version";

conflict lapack

# Determine what compiler we're using

if { $machine == "cielito" } then {
   set compiler       intel
   set compilermajver 13
} else {

if { [info exists ::env(LCOMPILER) ] } {
    set compiler       $::env(LCOMPILER)

    if { [info exists ::env(LCOMPILERMAJVER) ] } {
       set compilermajver $::env(LCOMPILERMAJVER)
    } else {
       set compilerver [ exec icpc --version | grep icpc | awk {{print $3}} ]
       set compilermajver [ lindex [ split "$compilerver" "." ] 0 ]
    }

} else {
    set compiler    gcc
    set compilerver [ exec gcc --version | grep GCC | awk {{print $3}} ]
    set compilermajver [ lindex [ split "$compilerver" "." ] 0 ].[ lindex [ split "$compilerver" "." ] 1 ]
}
}

# local variables
set version     3.4.1;
set prefix      /projects/opt/draco/vendors/lapack-$version/${compiler}-${compilermajver}
set libdir      $prefix/lib;
set incdir      $prefix/include;

if { ![file exists $libdir] } {
    puts stderr "\n[module-info name]: $libdir: No such file or directory.\n"
    break
    exit 1
}

# module help
proc ModulesHelp { } {
   global version prefix bindir;
   puts stderr "\tLAPACK ($version)\n";
   puts stderr "\tLAPACK_LIB_DIR\t= $libdir";
#   puts stderr "\tLAPACK_INC_DIR\t= $incdir";
#   puts stderr "\tLAPACK_ROOT\t= $prefix";
#   puts stderr "\t\$LAPACK_LS_FLAGS, \$LAPACK_COMPILE_FLAGS";
}

#setenv          LAPACK_ROOT 	$prefix;
#setenv          LAPACK_LD_FLAGS  "-L/usr/lib64 -lgfortran -L$libdir -llapack -lcblas -lf77blas -latlas";
#setenv          LAPACK_COMPILE_FLAGS 	-I$prefix/include;

setenv          LAPACK_LIB_DIR  $libdir
#setenv          LAPACK_INC_DIR  $incdir
setenv          BLAS_blas_LIBRARY ${libdir}/libblas.a

