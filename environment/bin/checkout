#!/usr/bin/env python

"""
checkout.py

Checks out a variety of CCS-4 packages from the sourceforge server.

Usage:

   checkout [options] [package] [version]

The package argument may be omitted only if the -r <tagname> option is
used and the name of the package is the first word in the tag name,
e.g. -r wedgehog-4_3_0 implies a package name of 'wedgehog'

The package argument can refer to an entire package, e.g. 'draco' or a
component within the package, e.g. 'draco/tools'. In the latter case,
it may be desirable to use the -d option to specify a more compact
directory name.

Options:
-r <tagname>   Check out a particular tagged version. If [package] is
               not given, extract it from the tagname as package-###.
-d <dir>       Create <dir> to hold the checked out sources, instead
               of a directory based on the pacakge name,
-e             Export sources, instead of checking them out. (No CVS
               dirs). Cannot be used with head version.
-n  --dry-run  Causes the cvs command to be printed but not executed.
-h  --help     Prints this message and exits.
-l  --list     Lists the available packages for checkout and exits.

Examples:

  > checkout draco           # Checks out the head version of draco
  > checkout draco 4_1_0     # Checks out release 4_1_0 of draco
  > checkout -r draco-4_1_0  # Ditto

  > checkout -r Camel_Norton uncleMcFlux
  # Checks out the Camel_Norton branch of Uncle Mcflux. Note that the
  # package name is not optional as it does not appear in the tag.

  > checkout draco/tools
  # Checks out the tools component of draco into directory draco/tools.

  checkout draco/tools -d tools      # Ditto, but into directory tools.
"""

from Utils import disambiguate, AmbiguousKeyError, InvalidKeyError, padlist
import sys, os, getopt

package_archive = {'draco'      :'draco',
                   'tools'      :'jayenne',
                   'imcdoc'     :'jayenne',
                   'clubimc'    :'jayenne',
                   'milagro'    :'jayenne',
                   'wedgehog'   :'jayenne',
                   'uncleMcFlux':'jayenne'}

package_list = ', '.join(package_archive.keys())

def list_packages(): print "Available Packages:", package_list

username =  os.environ['LOGNAME']

try:
    options, words = getopt.getopt(sys.argv[1:], 'r:d:hnle', \
                                   ['help','dry-run', 'list'])
except getopt.GetoptError:
    sys.exit('ERROR: bad option or missing argument')

# Convert options into a dictionary for easier key lookup.
options = dict(options)

tag =       options.get('-r','')
directory = options.get('-d','')

package = ''
archive = ''
command = 'checkout'
dry_run = False;

if '-h' in options or '--help' in options:
    print __doc__
    list_packages()
    sys.exit()

if '-n' in options or '--dry-run' in options:
    dry_run = True;

if '-l' in options or '--list' in options:
    list_packages()
    sys.exit()

if '-e' in options:
    command = 'export'


# Attempt to find package name
package = tag.split('-')[0];
if package not in package_archive.keys():
    print "Could not determine package name from tag: %s. " \
          "Looking elsewhere." % (tag,)
    package = ''

# If we don't have a package, try and get it from the first
# argument. If this argument contains '/' treat the first part before
# '/' as the package name and the rest as a component

if not package:
    try:
        package_name = words[0]
        package_parts = package_name.split('/',1)
        package_parts[0] = disambiguate(package_parts[0], package_archive.keys())
        package_name = '/'.join(package_parts)

        package = package_parts[0]

    except IndexError:
        sys.exit("ERROR: No package name given.")
    except AmbiguousKeyError:
        sys.exit("ERROR: Ambiguous package name.")
    except InvalidKeyError:
        sys.exit("ERROR: Unrecognized package name.")


# Look up the archive name, catch (unlikely at this point) invalid
# package names. 
try:
    archive = package_archive[package]
except KeyError:
    sys.exit("ERROR: Unrecognized package name: %s" % package)
    


# If we don't have a tag yet, look for a version number in the second
# argument. If we find one, make a tag from it. Otherwize, leave the
# tag field empty. This will cause cvs to default to the head version.

if not tag:
    try:
        version = words[1]
    except IndexError:
        print "Using head version"
    else:
        tag = "%s-%s" % (package, version)


# Build the cvs command:

if tag:       tag = "-r %s" % tag
if directory: directory = "-d %s" % directory;

command = "cvs -z9 -d /codes/radtran/cvsroot/ %s %s %s %s" % \
          (command, directory, tag, package_name)

print "%s" % command

if not dry_run:
    command_out = os.popen(command)
    output = command_out.read()
    print output

