#!/bin/bash -l

#MSUB -l walltime=01:00:00
#MSUB -l nodes=1:ppn=16
#MSUB -j oe
#MSUB -o /usr/projects/draco/draco-6_17_0/logs/release_ct_test.log

# Helpful functions:
die () { echo "ERROR: $1"; exit 1;}

run () {
    echo $1
    if ! test $dry_run; then
    eval $1
    fi
}

#----------------------------------------------------------------------#
# The script starts here
#----------------------------------------------------------------------#

echo "Here we go..." > /usr/projects/draco/draco-6_17_0/logs/release_ct_test.log

# Permissions - new files should be marked u+rwx,g+rwx,o+rx
umask 0002
build_permissions="g+rwX"
install_permissions="g+rwX,o=g-w"

# environment (use draco modules)
run "module use /usr/projects/draco/vendors/Modules/hpc"

run "module load user_contrib"
run "module unload PrgEnv-intel PrgEnv-pgi"
run "module unload cmake numdiff svn gsl"
run "module unload papi perftools trilinos"
run "module load PrgEnv-intel"
run "module unload xt-libsci xt-totalview"
run "module swap intel intel/14.0.4.211"
run "module load gsl/1.15"
run "module load cmake/3.3.1 numdiff svn"
run "module load trilinos SuperLU_DIST"
run "module load ParMetis ndi random123 eospac/v6.2.4"
run "module list"

export OMP_NUM_THREADS=8

# Define your source and build information here.

ddir="draco-6_17_0"
platform="ct"
dmpi=craympich2 # mpt string?
df90=intel1404
dcpp=intel1404

source_prefix="/usr/projects/draco/$ddir"
build_prefix="/lscratch1/$USER/$ddir/$platform-${dmpi}-${df90}-${dcpp}"
install_prefix="$source_prefix/$platform-${dmpi}-${df90}-${dcpp}"

MAKE="make -j48"
CC=`which cc`
CXX=`which CC`
FC=`which ftn`
printenv

# =============================================================================
# checkit_core
#
# This script can be used either stand-alone or sourced into a buildit
# script which defines the variables that it needs.
#
# It requires the following enviromnent variables to be defined:
#
# |----------------+-------------+--------------------------------------------|
# | Name           | Specificity | Description                                |
# |----------------+-------------+--------------------------------------------|
# | build_prefix   | build       | Destination directory of the build trees.  |
# | MAKE           | platform    | Make command.                              |
# |----------------+-------------+--------------------------------------------|
#
# Optionally, if "dry_run" is defined, all commands are output to
# stdio, but not executed. This can be useful to create a "rebuild"
# script which repeats the configure and build process.
#
#
# Results:
#
# This script runs $MAKE run in four versions of the code: debug,
# debug_nodbc, opt, and opt_log.
#
# =============================================================================

# Define the meanings of various configure features:
# DBC_OFF="-DDRACO_DBC_LEVEL=0"
# DBC_ON="-DDRACO_DBC_LEVEL=7"

OPTIMIZE_ON="-DCMAKE_BUILD_TYPE=Release"
OPTIMIZE_OFF="-DCMAKE_BUILD_TYPE=Debug"

LOGGING_ON="-DDRACO_DIAGNOSTICS=7 -DDRACO_TIMING=1"
LOGGING_OFF="-DDRACO_DIAGNOSTICS=0 -DDRACO_TIMING=0"

# Define the meanings of the various code versions:

VERSIONS=( "debug" "opt" )
OPTIONS=(\
    "$DBC_ON  $OPTIMIZE_OFF $LOGGING_OFF $NR_OFF" \
    "$DBC_OFF $OPTIMIZE_ON  $LOGGING_OFF $NR_OFF" \
)

PACKAGES=("draco")

# =============
# Configure, Build and Run the Tests
# =============

# Loop over the code versions:

for (( i=0 ; i < ${#VERSIONS[@]} ; ++i )); do

    version=${VERSIONS[$i]}
    options=${OPTIONS[$i]}

    echo
    echo
    echo "# Code Version: $version"
    echo "# ------------"
    echo

    # Create install directory
    install_dir="$install_prefix/$version"
    run "mkdir -p $install_dir" || die "Could not create $install_dir"

    # Loop over the packages.
    for package in ${PACKAGES[@]};  do
        echo
        echo "#    Package: $package"
        echo "#    -------"
        echo

        source_dir="$source_prefix/source/$package"
        build_dir="$build_prefix/$version/${package:0:1}"

        run "cd $build_dir"
        run "ctest -j16"

    done


done
